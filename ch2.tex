% !TeX spellcheck = es_ES
% !TeX encoding = ISO-8859-1

En este capítulo se documentarán los fundamentos sobre Medidores de energía, Redes WiFi Malladas y el protocolo modbus.

\section{Fundamentos de medición consumo de energía eléctrica}

\subsection{Definición}

Los medidores de consumo de energía eléctrica, también llamados contadores de energía debido a la tarea que desempeñan, son ``Un instrumento destinado a medir la energía eléctrica integrando la potencia con respecto al tiempo" \hspace*{1mm} \cite{energy-m-IEC}. Las compañías de electricidad utilizan medidores de energía instalados en cada cliente con el propósito de monitorear y facturar el consumo. Debido a ello estos equipos suelen estar calibrados en unidades de facturación de energía, comúnmente se utiliza el kilovatio hora [kWh] y se lee el valor registrado en cada medidor una vez ha llegado el período de cobranza.\\

Cuando se desea ahorrar energía durante ciertos periodos de tiempo, algunos medidores pueden registrar la demanda de energía, es decir el máximo uso de potencia en un intervalo de tiempo. Aplicar esta metodología de registro de demanda brinda la capacidad de variar las tarifas de electricidad durante el día, permitiendo registrar el consumo de cada usuario durante periodos de tarifas altas (picos de demanda) o en casos de tarifas bajas donde la demanda de energía en el sistema es baja y la energía menos costosa. Incluso en algunas áreas los medidores de energía poseen relés para desprendimiento de cargas por un periodo de tiempo en caso de picos muy altos de demanda.

\subsection{Clasificación de los medidores}

Tomando como referencia lo que \cite{DianaL} refleja en su trabajo, los medidores de consumo de energía pueden agruparse mediante las siguientes clasificaciones.

\subsubsection{Según el principio de funcionamiento}

\begin{itemize}
	\item[] \textbf{Medidores electromecánicos}: El tipo más común de medidor eléctrico, el registro de la energía se realiza mediante el conteo de las revoluciones de un disco metálico que es conductor eléctrico pero no conductor magnético. Este disco se hace rotar mediante la inducción electromagnética generada por la alimentación, a una velocidad proporcional a la potencia que pasa a través del medidor. El número de vueltas es entonces proporcional a el consumo de energía. 
		
	
	\item[] \textbf{Medidores electrónicos}: De forma general este medidor está compuesto por la alimentación, un circuito de medición, un circuito de procesamiento (usualmente microcontroladores) y comunicación además de otros módulos agregados como un RTC, una pantalla de cristal líquido, un módulo de comunicación mediante infrarrojo, entre otros.\\
	
	El circuito de medición está compuesto por muestreadores y cuantificadores conectados a las entradas de corriente y tensión, así como a la referencia de tensión. Esto viene seguido por una sección de conversión analógica-digital para encontrar el equivalente digitalizado del valor de las entradas. Dichas entradas en formato digital son tratadas utilizando un procesador digital de señal para calcular los distintos parámetros de medición.
		
	Este tipo de medidor muestra la energía consumida en una pantalla LCD o LED, además de medir la energía consumida pueden también registrar otros parámetros de la carga y del suministro, como la tasa de demanda instantánea y máxima.
	
\end{itemize}

\subsubsection{Según su construcción:}

\begin{itemize}
	\item[] \textbf{Medidor monofásico bifilar (una fase y neutro)}:\\
	Está compuesto por una bobina de tensión y una de corriente. Su capacidad usualmente está entre 15 A y 60 A. 
	
	\item[] \textbf{Medidor bifásico bifilar (dos fases)}:\\
	Está compuesto por dos bobinas de tensión y dos bobinas de corriente. Usualmente utilizado para medir la enegía eléctrica consumida por aparatos que funcionan con la tensión fase-fase residencial.
	
	\item[] \textbf{Medidor bifásico trifilar (dos fases y neutro)}:\\
	Está compuesto por dos bobinas de tensión y dos bobinas de corriente. Se usa para medir la energía consumida por aparatos que requieran para su funcionamiento dos fases, con este medidor se puede medir la energía consumida por otros aparatos conectados a la misma instalación que funcionen con una sola fase.
	
	\item[] \textbf{Medidor trifásico tetrafilar (tres fases y neutro)}:\\ Está compuesto por tres bobinas de tensión y tres bobinas de corriente. Se utiliza para medir la energía consumida por aparatos que requieran funcionar con tres fases.
	
\end{itemize}

\subsection{Infraestructuras de medición de energía}

La infraestructura de cada sistema de medición es la característica que delimita sus particularidades, ``El cambio de visión de la medición de energía eléctrica se realiza desde el año de 1970 con la incorporación del envío de datos, la comunicación en los años 70 era unidireccional, en una sola vía, desde el usuario hasta la empresa distribuidora. La primera etapa fue la medición AMR (Automatic Meter Reading) y duró alrededor de 30 años dando paso a la evolución, llamada medición inteligente o smart Metering. Smart metering requiere un alto grado de telecomunicaciones en ambas vías: usuario-empresa distribuidora." \hspace*{1mm} \cite{RuizM}.\\

La meta en cuanto a estos sistemas es llegar a una medición inteligente avanzada, es decir incorporar a toda la red eléctrica dispositivos con la capacidad de operar por medio de telecomunicaciones, permitiendo equilibrar la generación de energía eléctrica al consumo real, por medio de los datos enviados por todos los medidores inteligentes.\\

Existen ciertos requerimientos para realizar una medición inteligente: alta confiabilidad, vida útil, interoperabilidad, rentabilidad, seguridad, consumo mínimo de energía, bajos costos de instalación y mantenimiento. La tecnología desarrollada debe cumplir con estos requerimientos para ser realmente funcional en el campo de la medición automática de consumo.\\

Para realizar medición inteligente se pueden emplear diferentes tipos de tecnologías de telecomunicaciones de acuerdo al área de aplicación y al canal de transmisión. La figura \ref{fig:infraestructura} muestra los tipos de arquitecturas de comunicación que son empleadas en la medición inteligente. Los medios guiados para realizar telecomunicaciones incluyen la red telefónica pública conmutada (PSTN), PLC portadora en la línea de alimentación, Ethernet y cable módems. Los medios no guiados para realizar telecomunicaciones incluyen WiFi, ZigBee, infrarrojos, RFID y GSM / GPRS / CDMA celular.\\


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\linewidth]{img/infraestructura.png}
	\captionsource{Infraestructura general de un sistema de medición avanzado}{Adaptado de \cite{MAlvarado}}
	\label{fig:infraestructura}
\end{figure}

La infraestructura necesaria para la medición inteligente se divide en tres zonas de acuerdo al tipo de comunicación \cite{MAlvarado}, dichas zonas son las siguientes:

\begin{itemize}
	\item Red de área local (HAN).
	\item Red de área de vecindad (NAN). 
	\item Red de área amplia (WAN).
\end{itemize}

\subsubsection{Red de área local (Home Area Network)}

Es un sistema integrado dentro de los hogares que permite la comunicación entre diferentes dispositivos inteligentes, el dispositivo límite de esta red es el medidor de energía eléctrica. Este tipo de redes puede utilizar comunicaciones cableadas como BPL (Broadband over Power Lines) o PLC (Power Line Carrier) pero también comunicaciones inalámbricas como redes privadas,	 una red de banda ancha o redes malladas para comunicarse con la red NAN.
\\


\subsubsection{Red de vecindad (Neighbourhood Area Network)}

Este tipo de red permite la conexión entre múltiples HANs, es un sistema de interconexión entre redes de medidores inteligentes. El principal elemento que lo constituye es el concentrador. El concentrador es el dispositivo que actúa como un puente entre los contadores inteligentes y la puerta de enlace. El concentrador de datos detecta y gestiona los medidores inteligentes de forma automática, realiza lecturas de los consumos y transfiere la información a los centros de control, también facilitan los mensajes de diagnostico, actualizaciones de firmware y supervisión de las condiciones de loss medidores.\\


\subsubsection{Red de área amplia (Wide Area Network)}

Es la red encargada de conectar múltiples sistemas de distribución y actúa como un puente entre redes de menor tamaño y la red del cliente. Debe ofrecer una red de retorno para conectar los servicios de recolección de datos con las instalaciones del cliente. Dicha red de retorno puede adoptar una variedad de tecnologías (Ethernet, red celular, banda ancha) para transferir la información extraída de las redes NAN a las oficinas locales de servicios públicos. Una puerta de enlace perteneciente a la red WAN puede utilizar la conexión de banda ancha o una red basada en IP para proporcionar un acceso para que el cliente puede acceder a los datos requeridos. La privacidad, fiabilidad y seguridad de la información son los principales aspectos que se evalúan en este tipo de redes.

\begin{figure}[h!]
	\centering
	\includegraphics[width=1.0 \linewidth]{img/Infraestructura1}
	\caption{Arquitectura de red en comunicaciones para medición inteligente. J. Ekanayake and K. Liyanage, SMART GRID TECHNOLOGY AND APPLICATIONS, First edit. New Delhi, 2013.}
	\label{fig:infraestructura1}
\end{figure}


\subsection{Normativa aplicada a las redes de medición}
	
Los problemas en redes de medición suelen ocurrir cuando falla la interoperabilidad entre los distintos sistemas que las componen, esto es causado por la transmisión de datos que se efectúa a través de diversas redes y sistemas de comunicación. Es por ello que la interoperabilidad se convierte en algo fundamental, permitiendo a la infraestructura y la información fluir correctamente en un sistema interoperable perimitiendo el intercambio de datos sin necesidad de la intervención manual. El punto más relevante de la interoperabilidad es proporcionar un sistema con la capacidad de integrar componentes plug-and-play, esto se refiere a la capacidad de configurar los componentes y el sistema principal automáticamente comienza a operar con solo conectarlo. Aunque es un concepto sencillo en muchas situaciones puede llegar a ser complejo y poco práctico mostrar una interfaz estándar entre dos sistemas diferentes. Estas consideraciones en la interoperabilidad no solo reducen los costos de instalación y de integración sino que también definen los requisitos que un componente nuevo debe tener para conectarse al sistema existente, lo que se refleja en la sustitución sencilla de componentes y en una alta escalabilidad del sistema en caso de una mayor demanda o implementación de tecnologías más eficientes.\\


\subsubsection{Modelo OSI}

Existen diferentes modelos y arquitecturas referenciales para el diseño de un sistema, el primer modelo creado por la ISO en 1980 es llamado OSI (Open System Interconnection) es un estándar que tiene por objetivo conseguir interconectar sistemas de procedencia distinta para que estos pudieran intercambiar información sin ningún tipo de impedimentos debido a los protocolos con los que estos operaban de forma propia según su fabricante. El modelo OSI está conformado por 7 capas o niveles de abstracción:

\begin{itemize}
	\item[1.] De aplicación
	\item[2.] De presentación
	\item[3.] De sesión
	\item[4.] De transporte
	\item[5.] De red
	\item[6.] De enlace de datos
	\item[7.] Capa física
	
\end{itemize}

Cada uno de estos niveles ejerce sus propias funciones para que en conjunto el sistema sea capaz de alcanzar su objetivo final. Es por esta abstracción que el modelo hace posible la intercomunicación en diferentes sistemas al delimitar las funciones que debe realizar cada capa de operación. Es importante aclarar que el modelo OSI no es la definición de una topología ni un modelo de red en sí mismo. Tampoco especifica ni define los protocolos que se utilizan en la comunicación, ya que estos están implementados de forma independiente a este modelo. Lo que realmente hace OSI es definir la funcionalidad de ellos para conseguir un estándar.


\begin{itemize}
	\item \textbf{Capa de aplicación}: Ofrece la posibilidad de acceder a los servicios de las demás capas. Define los protocolos que utilizan las aplicaciones para intercambiar datos. Normalmente el usuario no interactúa con esta capa sino con programas que sirven de interfaz para ocultar el nivel de complejidad subyacente.
	
	\item \textbf{Capa de presentación}: Se encarga de representar la información funcionando como un traductor entre equipos. En esta capa se trabajan más los datos en sí que cómo se establece el enlace para que estos lleguen. Se tratan aspectos como la semántica (qué significan) y la sintaxis (formato de los datos) para garantizar la compatibilidad con los equipos del sistema. También es la encargada de cifrar los datos y comprimirlos de ser necesario.
	
	\item \textbf{Capa de sesión}: Esta capa es la que se encarga de mantener y controlar el enlace establecido entre dos computadores que están transmitiendo datos de cualquier índole. Por lo tanto, el servicio provisto por esta capa es la capacidad de asegurar que, dada una sesión establecida entre dos máquinas, la misma se pueda efectuar para las operaciones definidas de principio a fin, reanudándolas en caso de interrupción. En muchos casos, los servicios de la capa de sesión son parcial o totalmente prescindibles.
	
\end{itemize}

\subsubsection{GWAC}

La integración de la automatización asociada con los recursos eléctricos es importante para respaldar una mayor eficiencia e incorporar recursos renovables, variables y vehículos eléctricos en el sistema eléctrico. Los problemas de integración que enfrenta esta comunidad son análogos a los que enfrenta la industria de la salud, los servicios de emergencia y otras comunidades complejas con muchas partes interesadas. Para resaltar este problema y fomentar la comunicación y el desarrollo de una comunidad de interoperabilidad de redes inteligentes, el GridWise Architecture Council (GWAC) creó un Marco de establecimiento de contexto de interoperabilidad. Este "modelo conceptual" ha sido útil para explicar la importancia de la alineación organizativa, además de las especificaciones de interfaz técnica e informativa para dispositivos y sistemas de "redes inteligentes". Como siguiente paso para construir una comunidad sensible a la interoperabilidad, el GWAC ha estado desarrollando un Modelo de madurez de interoperabilidad de redes inteligentes (SG IMM) tomando prestado del trabajo realizado por otros para abordar circunstancias similares. El modelo proporciona un medio para medir el estado y el progreso, analizar las brechas y priorizar los esfuerzos para mejorar la situación. El objetivo es crear una herramienta, o un conjunto de herramientas, que fomente una cultura de interoperabilidad en la comunidad de redes inteligentes. En la siguiente ilustración se hace referencia a una comparación de OSI y GWAC con sus respectivos niveles o capas cada uno:

\begin{figure}[h!]
	\centering
	\includegraphics[width=1\linewidth]{img/OSIGWAC}
	\caption{E. Hossain, Z. Han, and V. Poor, Smart Grid Communications and Networking. New York: CAMBRIDGE UNIVERSITY PRESS, 2012.}
	\label{fig:osigwac}
\end{figure}

\section{Sobre el protocolo Modbus}

\subsection{Definiciones}

\subsection{Modbus RTU}

Modbus es un protocolo de comunicaciones, basado en la arquitectura maestro/esclavo o cliente/servidor, diseñado en 1979 por Modicon para su gama de controladores lógicos programables (PLCs).\\

Debido a que este protocolo fue público, de fácil uso y que requiere poco desarrollo (maneja bloques de datos sin suponer restricciones) se convirtió en un protocolo de comunicaciones estándar en la industria. Es el protocolo de mayor disponibilidad para la conexión de dispositivos electrónicos industriales. Un ejemplo de trama modbus es la siguiente:

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/modbusRTUTrama}
	\caption{Ejemplo ilustrativo de una trama modbus RTU. Tomado de \cite{Logicbus}}
	\label{fig:modbusrtutrama}
\end{figure}


El protocolo Modbus permite el control de una red de dispositivos, por ejemplo un equipo de medición temperatura y humedad puede comunicar los resultados a una PC. Modbus también se usa para la conexión de un PC de supervisión con una unidad remota (RTU) en sistemas de supervisión de adquisición de datos (SCADA). Existen versiones del protocolo Modbus para puerto serial y Ethernet (Modbus/TCP).\\


\subsection{Modbus TCP}

Modbus/TCP es un protocolo de comunicación diseñado que permite a equipos industriales tales como PLCs, PC, drivers para motores y otros tipos de dispositivos físicos de entrada/salida, comunicarse sobre una red Ethernet. Fue introducido por Schneider Automation como una variante de la familia de protocolos MODBUS, ampliamente usada para la supervisión y el control de equipo de automatización. Específicamente el protocolo define el uso de mensajes MODBUS en un entorno intranet o internet usando los protocolos TCP/IP.\\

La especificación Modbus/TCP define un estándar interoperable en el campo de la automatización industrial, el cual es simple de implementar para cualquier dispositivo que soporte sockets TCP/IP. Todas las solicitudes son enviadas vía TCP sobre el puerto registrado 502 y normalmente usando comunicación half-duplex sobre una conexión dada. Es decir, no hay beneficio en enviar solicitudes adicionales sobre una conexión única mientras una respuesta está pendiente. Modbus/TCP básicamente encapsula una trama MODBUS dentro de una trama TCP.\\

\subsection{Algunos beneficios sobre el protocolo Modbus RTU ó TCP}

\begin{itemize}
	\item De código abierto, no se requiere pagar por licencia.
	\item Ampliamente soportado por HMIs o softwares SCADA
	\item Fácil de usar
	\item Se pueden integrar varios equipos de manera sencilla
	\item Bajo costo de desarrollo
	\item Conocido ampliamente en la industria
\end{itemize}

\section{Redes malladas}

\subsection{Definición}

Una red WiFi mallada se puede definir como una red que permite la comunicación entre nodos a través de múltiples saltos en una topología mallada \cite{bahr}. Un nodo es la unidad mínima de la red,
estas unidades son las encargadas de generar los enlaces entre los dispositivos usuarios que construyen la red mallada. 

Por lo general estas redes poseen clientes, enrutadores y puertas de enlace. Los clientes son dispositivos electrónicos, sistemas embebidos o sensores que pueden comunicarse con otros en la red. El enrutador es un dispositivo electrónico que sirve como un intermediario entre dos o más redes para transportar los datos de una red a otra. Y las compuertas de enlace son dispositivos electrónicos que conectan la red con Internet. \cite{VazquezA}

Cuando un nodo no puede operar, el resto de los nodos en la red WiFi mallada aún pueden comunicarse con los otros, bien sea, directa o indirectamente a través de uno o más nodos intermediarios \cite{ScienceDirect}

%Aquí debería poner una imagen sobre las redes mesh

\subsection{Caracteristicas}

La red de Internet como la conocemos es el ejemplo más conocido y similar a una red mallada, puesto que Internet es una red con gran cantidad de nodos en los que el mensaje es enviado desde un punto y es recibido en otro mediante un enrutado inherente a la red. Tomando este ejemplo como base se pueden delimitar algunas características de esta topología de red:\\

\begin{itemize}
	\item Permite que el camino recorrido por el mensaje entre un punto y otro sea dinámico, es decir, que la ruta que toma el mensaje cambie si se requiere debido a la ocurrencia de algún evento que impidan la comunicación con un nodo intermedio específico.
	\item Ofrece una mayor cantidad de rutas posibles para el mensaje ya que idealmente cada nodo puede conectarse con cualquier otro directamente o a través de terceros.
	\item Cada nodo posee un identificador único en la red que lo diferencia de los demás nodos para que no haya errores en el direccionamiento de la información.
\end{itemize}

\subsubsection{Sobre los protocolos de enrutamiento en las redes Malladas}

 Esta capacidad de elegir la ruta debe estar basada en algoritmos para determinar el camino óptimo que será recorrido por el mensaje. Este algoritmo de enrutamiento debe tomar en cuenta las distintas condiciones que puede presentar el medio de transmisión, las interferencias o ruido que pueda existir según la banda de transmisión, la posible colisión de datos en un nodo, etc, para así determinar hacia dónde debe ir el mensaje en cada nodo para llegar a su destino.\\
 
 La implementación de topologías malladas en sistemas embebidos ha encontrado problemas en la necesidad de procedimientos adicionales relacionados con el enrutamiento. Hay algunos ejemplos de protocolos que soportan la red mallada sobre una red IP, por ejemplo el protocolo B.A.T.M.A.N (Better Approach To Mobile Adhoc Networking), Babel (Protocolo de distancia de vector para IPv6 y IPv4 con  propiedades de convergencia rápida), HWMP (Protocolo Híbrido Inalámbrico Mallado), entre otros \cite{VazquezA}. El problema surge en la implementación de la pila TCP/IP en estos sistemas puesto que un sistema embebido posee recursos de cómputo limitados. Es por ello que se debe seleccionar según la aplicación el poder de cómputo necesario y la topología de la red que se requiere para cumplir con cada solución. Para que el mensaje tenga un destinatario debe existir una manera de identificar cada nodo de una red mallada, en el caso de la red mallada WiFi se utiliza la dirección MAC para diferenciar un nodo de otro.
 
 \subsubsection{Direccionamiento por MAC}
 
 En una red de computadoras, la dirección MAC es un valor único asociado a  un adaptador de red. La dirección MAC también es conocida como dirección de hardware o dirección física del adaptador \cite{VazquezA}. Las direcciones MAC se componen de doce números hexadecimales (48 bits de longitud). Por convención las direcciones MAC son escritas en uno de los dos
 formatos siguientes:
 
 \begin{equation}
 	MM:MM:MM:SS:SS:SS \hspace{.5cm} o \hspace{.5cm} MM-MM-MM-SS-SS-SS
 \end{equation}
 
 La primera mitad de la dirección MAC contiene el número identificador del fabricante del adaptador (i.e. 00:A0:C9:14:C8:29). Dichos identificadores están regulados por un estándar de Internet. La segunda parte de la dirección MAC representa el número de serial asignado al adaptador por el fabricante. \cite{VazquezA}

\section{La red mallada ESP-MESH}

\subsection{Definición}

Una red Wi-Fi de infraestructura tradicional es una red punto a multipunto donde un único nodo central conocido como punto de acceso (AP) está conectado directamente a todos los demás nodos conocidos como estaciones (STA). El AP es responsable de arbitrar y reenviar las transmisiones entre las estaciones. Algunos AP también retransmiten transmisiones hacia/desde una red IP externa a través de un enrutador. Las redes Wi-Fi de infraestructura tradicional sufren la desventaja de un área de cobertura limitada debido al requisito de que cada estación debe estar dentro del alcance para conectarse directamente con el AP. Además, las redes Wi-Fi tradicionales son susceptibles de sobrecarga ya que el número máximo de estaciones permitidas en la red está limitado por la capacidad del AP. \\

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/TradicionalWifi}
	\caption{Ilustración de una red Wi-Fi tradicional. Tomada desde \cite{ESP-MESH}}
	\label{fig:tradicionalwifi}
\end{figure}


Proporcionada por espressif la red mallada ESP-MESH, se diferencia de las redes Wi-Fi de infraestructura tradicional en que no es necesario que los nodos se conecten a un nodo central. En cambio, los nodos pueden conectarse con nodos vecinos. Los nodos son mutuamente responsables de retransmitir las transmisiones de los demás. Esto permite que dicha red tenga un área de cobertura mucho mayor, ya que los nodos aún pueden lograr la interconectividad sin necesidad de estar dentro del alcance del nodo central. Asimismo, ESP-MESH también es menos susceptible a sobrecargas, ya que el número de nodos permitidos en la red ya no está limitado por un solo nodo central. \cite{ESP-MESH}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/ESPMESHWifi}
	\caption{Ilustración de una red Wi-Fi ESP-MESH. Tomada desde \cite{ESP-MESH}}
	\label{fig:espmeshwifi}
\end{figure}

\subsection{Terminología en la ESP-MESH}

\begin{itemize}
	\item \textbf{Nodo:} Cualquier dispositivo que es o que puede ser parte de una red ESP-MESH.
	\item \textbf{Nodo raíz (root, root node):} Es el nodo cima de la red, este nodo se conecta a la puerta de enlace.
	\item \textbf{Nodo hijo (child, child node):} Es un nodo X que establece conexión con un nodo Y. Dicho nodo Y se encuentra más cerca del nodo raíz que el nodo X.
	\item \textbf{Nodo padre (padre, parent node):} Es un nodo Y que establece conexión con un nodo X, el nodo X se encuentra más lejos del nodo raíz que el nodo X.
	\item \textbf{Nodo descendiente (descendant node):} Cualquier nodo accesible mediante la repetición del proceso padre a hijo.
	\item \textbf{Nodos hermanos (sibling nodes):} Nodos que comparten el mismo nodo padre.
	\item \textbf{Conexión:} Una asociación Wi-Fi tradicional entre un AP y una estación. Un nodo en ESP-MESH utilizará su interfaz de estación para asociarse con la interfaz softAP de otro nodo, formando así una conexión. El proceso de conexión incluye los procesos de autenticación y asociación en Wi-Fi.
	\item \textbf{Salto inalámbrico (wireless hop):} La parte de la ruta entre el nodo de origen y de destino para un mensaje que corresponde a una única conexión inalámbrica. Un paquete de datos que atraviesa una sola conexión se conoce como salto único, mientras que atravesar varias conexiones se conoce como salto múltiple.
	\item \textbf{Subred:} Subdivisión de una red ESP-MESH que consta de un nodo y todos sus nodos descendientes. Por lo tanto, la subred del nodo raíz consta de todos los nodos de una red ESP-MESH.
	
\end{itemize}

\subsection{Topología de árbol sobre la red ESP-MESH}

ESP-MESH está construido sobre la infraestructura del protocolo Wi-Fi y se puede considerar como un protocolo de red que combina muchas redes Wi-Fi individuales en una sola WLAN. En Wi-Fi, las estaciones se limitan a una sola conexión con un AP (conexión ascendente) en cualquier momento, mientras que un AP se puede conectar simultáneamente a varias estaciones (conexiones descendentes). Sin embargo, ESP-MESH permite que los nodos actúen simultáneamente como una estación y un AP. Por lo tanto, un nodo en ESP-MESH puede tener múltiples conexiones descendentes usando su interfaz softAP, mientras que simultáneamente tiene una única conexión ascendente usando su interfaz de estación. Esto, naturalmente, da como resultado una topología de red de árbol con una jerarquía de padres e hijos que consta de varias capas.\\

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/treetopology}
	\caption{Topología de árbol observada en la red ESP-MESH luego de su establecimiento. Tomada de \cite{ESP-MESH}}
	\label{fig:treetopology}
\end{figure}


ESP-MESH es una red de múltiples saltos (multi-hop), lo que significa que los nodos pueden transmitir paquetes a otros nodos en la red a través de uno o más saltos inalámbricos. Por lo tanto, los nodos en ESP-MESH no solo transmiten sus propios paquetes, sino que también sirven como retransmisores para otros nodos. Siempre que exista una ruta entre dos nodos cualesquiera en la capa física (a través de uno o más saltos inalámbricos), cualquier par de nodos dentro de una red ESP-MESH puede comunicarse.

\subsection{Tipos de nodos en la red ESP-MESH}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/NodeTypes}
	\caption{Tipos de nodos en una red ESP-MESH. Tomada desde \cite{ESP-MESH}}
	\label{fig:nodetypes}
\end{figure}

\begin{itemize}
	\item \textbf{Nodo raíz:} Es el nodo superior de la red y sirve como la única interfaz entre la red ESP-MESH y una red IP externa. El nodo raíz está conectado a un enrutador Wi-Fi convencional y transmite paquetes hacia / desde la red IP externa a los nodos dentro de la red ESP-MESH. Solo puede haber un nodo raíz dentro de una red ESP-MESH y la conexión ascendente del nodo raíz solo puede ser con el enrutador. Con referencia al diagrama anterior, el nodo A es el nodo raíz de la red.
	\item \textbf{Nodo hoja:} Es un nodo al que no se le permite tener nodos secundarios (sin conexiones descendentes). Un nodo hoja solo puede transmitir o recibir sus propios paquetes, pero no puede reenviar los paquetes de otros nodos. Si un nodo está situado en la capa máxima permitida de la red, se asignará como nodo hoja. Esto evita que el nodo forme conexiones descendentes, lo que garantiza que la red no agregue una capa adicional. Algunos nodos sin una interfaz softAP (solo estación) también se asignarán como nodos hoja debido al requisito de una interfaz softAP para cualquier conexión descendente. Con referencia al diagrama anterior, los nodos L / M / N están situados en la capa máxima permitida de la red, por lo que se han asignado como nodos hoja.
	\item \textbf{Nodos padres intermedios:} Los nodos conectados que no son ni el nodo raíz ni un nodo hoja son nodos padres intermedios. Un nodo intermedio debe tener una única conexión ascendente (un único nodo padre), pero puede tener de cero a varias conexiones descendentes (de cero a varios nodos hijos). Por lo tanto, un nodo padre intermedio puede transmitir y recibir paquetes, pero también reenviar paquetes recibidos desde sus conexiones ascendentes y descendentes. Haciendo referencia al diagrama anterior, los nodos B a J son nodos padres intermedios. Los nodos padres intermedios sin conexiones descendentes, como los nodos E / F / G / I / J, no son equivalentes a los nodos hoja, ya que todavía se les permite formar conexiones descendentes en el futuro.
	\item \textbf{Nodos ociosos:} Los nodos que aún no se han unido a la red se asignan como nodos inactivos. Los nodos inactivos intentarán formar una conexión ascendente con un nodo padre intermedio o intentarán convertirse en el nodo raíz en las circunstancias correctas. Refiriéndose al diagrama anterior, los nodos K y O son nodos inactivos.
\end{itemize}

\subsection{Señales de reconocimiento y límites de intensidad de señal (RSSI)}

Cada nodo en ESP-MESH que pueda formar conexiones descendentes (es decir, tiene una interfaz AP) enviará periódicamente tramas beacon Wi-Fi. Los nodos utilizan tramas beacon para permitir que otros nodos detecten su presencia y conozcan su estado. Los nodos inactivos escucharán las tramas beacon para generar una lista de nodos padres potenciales, desde dicha lista el nodo inactivo formará una conexión ascendente.

La intensidad de la señal de una posible conexión ascendente está representada por el RSSI (Indicación de intensidad de la señal recibida) contenido en las tramas beacon del posible nodo padre. Para evitar que los nodos formen una conexión ascendente débil, ESP-MESH implementa un mecanismo de umbral RSSI para las tramas beacon. Si un nodo detecta una trama beacon con un RSSI por debajo del umbral preconfigurado, el nodo transmisor no se tendrá en cuenta para formar una conexión ascendente.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/rssithreshold}
	\caption{Ejemplo ilustrativo sobre el umbral RSSI. Tomado de \cite{ESP-MESH}}
	\label{fig:rssithreshold}
\end{figure}

En la imagen anterior \ref{fig:rssithreshold} el recuadro A ilustra la cantidad de nodos padres posibles que tiene cada nodo según el RSSI que recibe. En el recuadro B de dicha imagen se observa cómo un objeto que reduce el alcance de las transmisiones del nodo X afecta en la elección del padre, pues al tener el nodo Y un mayor RSSI en el nodo acaba siendo este el elegido para la conexión ascendente a pesar de encontrarse más lejos físicamente.\\


\subsection{Tablas de enrutamiento}

Cada nodo dentro de una red ESP-MESH mantendrá su tabla de enrutamiento individual utilizada para enrutar correctamente los paquetes ESP-MESH al nodo de destino correcto. La tabla de enrutamiento de un nodo en particular constará de las direcciones MAC de todos los nodos dentro de la subred del nodo en particular (incluida la dirección MAC del propio nodo en particular). Cada tabla de enrutamiento está dividida internamente en múltiples subtablas y cada subtabla corresponde a la subred de cada nodo hijo.\\


\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{img/routingtables}
	\caption{Ilustración de una red mallada, las tablas y subtablas de enrutamiento. Tomado de \cite{ESP-MESH}}
	\label{fig:routingtables}
\end{figure}


Usando el diagrama anterior como ejemplo, la tabla de enrutamiento del nodo B consistiría en las direcciones MAC de los nodos B a I (es decir, equivalente a la subred del nodo B). La tabla de enrutamiento del nodo B está dividida internamente en dos subtablas que contienen los nodos C a F y los nodos G a I (es decir, equivalentes a las subredes de los nodos C y G respectivamente).\\


La red utiliza las tablas de enrutamiento para determinar si un paquete debe reenviarse en sentido ascendente o descendente según las siguientes reglas:

\begin{enumerate}
	\item Si la dirección MAC de destino del paquete está dentro de la tabla de enrutamiento del nodo actual y no es el nodo actual, seleccione la subtabla que contiene la dirección MAC de destino y reenvíe el paquete de datos en sentido descendente al nodo secundario correspondiente a la subtabla.\\
	
	\item Si la dirección MAC de destino no se encuentra dentro de la tabla de enrutamiento del nodo actual, reenvíe el paquete de datos en sentido ascendente al nodo principal del nodo actual. Si lo hace repetidamente, el paquete llegará al nodo raíz, donde la tabla de enrutamiento debe contener todos los nodos dentro de la red.
\end{enumerate}


\section{Sistema operativo en tiempo real (RTOS)}

Un sistema operativo es un conjunto de órdenes y programas de un sistema informático que gestiona los recursos de hardware y provee servicios que permiten el funcionamiento de otros programas.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.25\linewidth]{img/osMarcoTeorico.png}
	\caption{Interacción del OS con otras capas del sistema informático.}
	\label{fig:osmarcoteorico}
\end{figure}


%Las aplicaciones ejecutan las funcionalidades que el usuario quiere o necesita. Los servicios del sistema operativo hace el desarrollo de aplicaciones rápido, simple, y mantenible.

La ventaja de utilizar sistemas operativos es que estos permiten gestionar los recursos de modo que se puedan ejecutar múltiples órdenes al mismo tiempo. Aunque en realidad cada procesador solo está ejecutando una orden a la vez, el sistema operativo es esa capa de abstracción que simula la ejecución en paralelo de varias tareas.

\subsection{FreeRTOS}

FreeRTOS es una implementación de un sistema RTOS que está diseñado para ser lo suficientemente liviano para correr en un microcontrolador. Este posee interfaces de programación que proveen planificadores en tiempo real, comunicación entre tareas, temporizadores y sincronización. Lo que quiere decir que una descripción más exacta sería tratarlo como un kernel en tiempo real. El planificador usado en el FreeRTOS, logra determinismo, proporcionando a los usuarios la capacidad de asignar prioridad a cada tarea de ejecución. 

\subsubsection{Tareas}
Las tareas se implementan como funciones. Cada tarea es un pequeño programa en sí mismo. Tiene un punto de entrada, se ejecuta normalmente de forma continua en un bucle infinito y no se cierra. 

\subsubsection{Colas}
Las colas proporcionan mecanismo de comunicación de una a otra
tarea, de una tarea a una interrupción y de una interrupción a una tarea. La comunicación se basa en la transferencia en un dato ubicado en la cola.


\subsubsection{Semáforos}

Los semáforos son muy similares a variables booleanas con la diferencia de que estos son utilizados para bloquear o desbloquear tareas, esperar a que ocurran eventos o cambios de un valor lógico y pueden ser activados desde una interrupción.

\subsubsection{Grupos de eventos}

Los grupos de eventos son espacios de memoria de hasta 23 bits en los que cada bit representa una variable booleana que puede utilizarse como una bandera para sincronizar tareas, bloquearlas o desbloquearlas. También puede ser llamada desde interrupciones.

\section{Microcontrolador ESP32}	%Debe ir aqui o en la descripción del hardware?
\subsection{Descripción}

El ESP-32 es un chip con integración WiFi y Bluetooth diseñado con la
tecnología de ultra bajo consumo de 40 nm. Este microcontrolador esta diseñado para aplicaciones móviles, electrónicos personales, y de Internet de las cosas (IoT). Posee características de bajo consumo, incluyendo reloj de alta precisión, múltiples estados de energía, y escalamiento de consumo dinámico.

Además es una solución integrada, que ya posee WiFi, Bluetooth, junto con alrededor de 20 componentes externos. El chip incluye una interruptor de antena, acoplador de radio-frecuencia, amplificador de potencia, amplificador de recepción de bajo ruido, filtros, y módulos de administración de consumo.

Este microcontrolador posee dos núcleos CPU que pueden ser individualmente controlados, con un reloj ajustable entre 80 MHz y 120 MHz. Además, usa el sistema operativo en tiempo real freeRTOS y tensión de alimentación nominal de 3,3 V.


\subsection{Caracteristicas}

\subsubsection{WiFi}

\begin{itemize}
	\item 802.11 b/g/n.
	\item 802.11 n (hasta 150Mbps).
	\item WMM.
	\item TX/RX A-MPDU, RX A-MSDU.
	\item Bloque de ACK inmediato.
	\item Defragmentación.
	\item Monitorización de faro automático (Hardware TSF).
	\item 4 interfaces virtuales WiFi.
	\item Soporte simultaneo para estación, Punto de acceso y modo promiscuo.
	\item Diversidad de antena.

\end{itemize}

\subsubsection{CPU y Memoria}

\begin{itemize}
	\item Doble núcleo Xtensa de 32 bits, hasta 600 MIPS.
	\item 448 kB ROM.
	\item 520 kB SRAM.
	\item 16 kB SRAM en RTC.
	\item Memoria flash embebida de hasta 16MB
\end{itemize}

\subsubsection{Relojes y temporizadores}

\begin{itemize}
	\item Oscilador interno con calibración de 8MHz, RC
	\item Oscilador externo de cristal desde 2 a 60MHz.
	\item Dos grupos de temporizadores, incluyendo 2x64-bits con un perro guardián en cada uno.
	\item TX/RX A-MPDU, RX A-MSDU.
	\item Un temporizador y un perro guardián RTC.
\end{itemize}

\subsubsection{Periféricos}

\begin{itemize}
	\item 34 GPIO mapeables.
	\item ADC de 12 bits con hasta 18 canales.
	\item Do convertidores de digital a analógico
	\item 10 sensores táctiles.
	\item 4 SPI, 2 $I^{2}C$, 3 UART
	\item 1 host (SD/eMMC/SDIO)
	\item Interfaz de MAC Ethernet con DMA dedicado y soporte IEEE 1588.
	\item CAN 2.0.
	\item Soporte simultaneo para estación, Punto de acceso y modo promiscuo.
	\item IR (TX/RX).
	\item Motor PWM.
	\item LED PWM hasta de 16 canales
	\item Sensor Hall.
\end{itemize}

\subsubsection{Seguridad}

\begin{itemize}
	\item Modo Boot seguro.
	\item Encriptación de flash.
	\item 1024-bits OTP, hasta 768-bit clientes
	\item Aceleración de criptografía por hardware:
	\begin{itemize}
		\item AES.
		\item SHA-2
		\item RSA
		\item ECC
	\end{itemize}
	\item 4 SPI, 2 $I^{2}C$, 3 UART
	\item 1 host (SD/eMMC/SDIO)
	\item Interfaz de MAC Ethernet con DMA dedicado y soporte IEEE 1588.
	\item CAN 2.0.
	\item Soporte simultaneo para estación, Punto de acceso y modo promiscuo.
	\item IR (TX/RX).
	\item Motor PWM.
	\item LED PWM hasta de 16 canales
	\item Sensor Hall.
\end{itemize}

